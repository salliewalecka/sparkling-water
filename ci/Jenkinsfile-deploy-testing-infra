#!/usr/bin/groovy
@Library('test-shared-library') _

node("docker") {
    cleanWs()
    checkout scm
    def commons = load 'ci/commons.groovy'

    stage("Deploy Testing Infrastructure on AWS") {
        commons.withAWSCredentials {
            commons.withTerraform {
                dir("ci/aws/terraform") {
                    commons.terraformApply()
                    def values = commons.extractTerraformOutputs(["docker_registry_id", "jenkins_url"])
                    def valuesAsString = values.collect{ "${it.key}=${it.value}" } join "\n" + "\n"
                    writeFile file: "infra.properties", text: valuesAsString
                }
            }
        }
    }

    stage("Save Infrastructure State") {
        commons.withGit {
            commons.gitCommit(["ci/aws/terraform/terraform.tfstate", "ci/aws/terraform/infra.properties"], "Saving Infrastructure State")
        }
    }
}
